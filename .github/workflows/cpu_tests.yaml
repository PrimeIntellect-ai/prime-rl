name: CPU Tests

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"
      - name: Install dependencies
        run: uv sync --all-extras --locked
      - name: Run tests
        env:
          USERNAME_CI: CI_RUNNER
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          # Set WANDB_MODE to online only if WANDB_API_KEY is available, otherwise set to offline
          # This is to allow running tests on forks without WANDB_API_KEY
          WANDB_MODE: ${{ secrets.WANDB_API_KEY && 'online' || 'offline' }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PRIME_API_KEY: ${{ secrets.PRIME_API_KEY }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          PYTEST_OUTPUT_DIR: /tmp/outputs
        run: PYTEST_OUTPUT_DIR=/tmp/outputs uv run pytest tests/unit -m "not gpu"
      - name: Cleanup output_dir
        run: rm -rf /tmp/outputs

  create-dev-tag:
    name: Create dev tag
    needs: unit-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Create next .dev tag from latest release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const latestRelease = await github.rest.repos.getLatestRelease({ owner, repo });
            const baseTag = latestRelease.data.tag_name;
            const prefix = `${baseTag}.dev`;

            const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            const pattern = new RegExp(`^refs/tags/${escapeRegex(baseTag)}\\.dev(\\d+)$`);

            for (let attempt = 0; attempt < 5; attempt += 1) {
              const refs = await github.paginate(github.rest.git.listMatchingRefs, {
                owner,
                repo,
                ref: `tags/${prefix}`,
              });

              let maxVersion = 0;
              for (const ref of refs) {
                const match = pattern.exec(ref.ref);
                if (match) {
                  const version = Number.parseInt(match[1], 10);
                  if (version > maxVersion) {
                    maxVersion = version;
                  }
                }
              }

              const nextVersion = maxVersion + 1;
              const tag = `${prefix}${nextVersion}`;

              try {
                await github.rest.git.createRef({
                  owner,
                  repo,
                  ref: `refs/tags/${tag}`,
                  sha,
                });
                core.notice(`Created tag ${tag} at ${sha}`);
                core.setOutput("tag", tag);
                return;
              } catch (error) {
                if (error.status === 422) {
                  core.warning(`Tag ${tag} already exists, retrying with next version...`);
                  continue;
                }
                throw error;
              }
            }

            core.setFailed("Could not create a unique .dev tag after retries.");
