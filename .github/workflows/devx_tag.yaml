name: DevX Tag

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  create-dev-tag:
    name: Create .dev tag
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Create next .dev tag from latest release
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            let latestTag;
            try {
              const latestRelease = await github.rest.repos.getLatestRelease({ owner, repo });
              latestTag = latestRelease.data.tag_name;
            } catch (error) {
              if (error.status === 404) {
                core.notice("No releases found. Skipping .dev tag creation.");
                return;
              }
              throw error;
            }

            const semverMatch = /^(v?)(\d+)\.(\d+)(?:\.(\d+))?$/.exec(latestTag);
            if (!semverMatch) {
              core.setFailed(`Latest release tag '${latestTag}' is not semver-like.`);
              return;
            }

            const [, versionPrefix, majorRaw, minorRaw, patchRaw] = semverMatch;
            const major = Number.parseInt(majorRaw, 10);
            const minor = Number.parseInt(minorRaw, 10);
            const patch = Number.parseInt(patchRaw ?? "0", 10) + 1;
            const baseTag = `${versionPrefix}${major}.${minor}.${patch}`;

            const prefix = `${baseTag}.dev`;
            const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
            const pattern = new RegExp(`^refs/tags/${escapeRegex(baseTag)}\\.dev(\\d+)$`);

            for (let attempt = 0; attempt < 5; attempt += 1) {
              const refs = await github.paginate(github.rest.git.listMatchingRefs, {
                owner,
                repo,
                ref: `tags/${prefix}`,
              });

              let maxVersion = 0;
              for (const ref of refs) {
                const match = pattern.exec(ref.ref);
                if (match) {
                  const version = Number.parseInt(match[1], 10);
                  if (version > maxVersion) {
                    maxVersion = version;
                  }
                }
              }

              const tag = `${prefix}${maxVersion + 1}`;

              try {
                await github.rest.git.createRef({
                  owner,
                  repo,
                  ref: `refs/tags/${tag}`,
                  sha,
                });
                core.notice(`Created tag ${tag} at ${sha}`);
                return;
              } catch (error) {
                if (error.status === 422) {
                  core.warning(`Tag ${tag} already exists, retrying...`);
                  continue;
                }
                throw error;
              }
            }

            core.setFailed("Could not create a unique .dev tag after retries.");
