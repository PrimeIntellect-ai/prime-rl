[{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656454320","pull_request_review_id":3621937504,"id":2656454320,"node_id":"PRRC_kwDON7QmxM6eVkaw","diff_hunk":"@@ -102,4 +104,21 @@ def init_buffers_post_meta(self) -> None:\n         raise NotImplementedError(f\"init_buffers_post_meta is not implemented for {self.__class__.__name__}\")\n \n \n-__all__ = [\"PreTrainedModelPrimeRL\"]\n+@dataclass\n+class PrimeModelOutput:\n+    logits: Tensor | None = None\n+    logprobs: Tensor | None = None\n+    entropy: Tensor | None = None\n+\n+    def __post_init__(self):","path":"src/prime_rl/trainer/models/base.py","commit_id":"235c67c76776b4dc0779694932995b40c520ad17","original_commit_id":"235c67c76776b4dc0779694932995b40c520ad17","user":{"login":"samsja","id":55492238,"node_id":"MDQ6VXNlcjU1NDkyMjM4","avatar_url":"https://avatars.githubusercontent.com/u/55492238?v=4","gravatar_id":"","url":"https://api.github.com/users/samsja","html_url":"https://github.com/samsja","followers_url":"https://api.github.com/users/samsja/followers","following_url":"https://api.github.com/users/samsja/following{/other_user}","gists_url":"https://api.github.com/users/samsja/gists{/gist_id}","starred_url":"https://api.github.com/users/samsja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samsja/subscriptions","organizations_url":"https://api.github.com/users/samsja/orgs","repos_url":"https://api.github.com/users/samsja/repos","events_url":"https://api.github.com/users/samsja/events{/privacy}","received_events_url":"https://api.github.com/users/samsja/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"I don't like this post init let's keep this data structure simple. We can create a function that do the same thing ","created_at":"2026-01-01T15:58:46Z","updated_at":"2026-01-01T15:58:46Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656454320","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656454320"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656454320"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656454320/reactions","total_count":1,"+1":1,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":113,"side":"RIGHT","author_association":"MEMBER","original_position":17,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591343","pull_request_review_id":3622037691,"id":2656591343,"node_id":"PRRC_kwDON7QmxM6eWF3v","diff_hunk":"@@ -285,19 +292,7 @@ def forward(\n         hidden_states = outputs.last_hidden_state\n         # Only compute necessary logits, and do not upcast them to float if we are not computing the loss\n         slice_indices = slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep\n-        logits = self.lm_head(hidden_states[:, slice_indices, :])\n-\n-        loss = None\n-        if labels is not None:\n-            loss = self.loss_function(logits=logits, labels=labels, vocab_size=self.config.vocab_size, **kwargs)\n-\n-        return CausalLMOutputWithPast(\n-            loss=loss,\n-            logits=logits,\n-            past_key_values=outputs.past_key_values,\n-            hidden_states=outputs.hidden_states,\n-            attentions=outputs.attentions,\n-        )\n+        return self.lm_head(hidden_states[:, slice_indices, :], labels[:, slice_indices], temperature=temperature)","path":"src/prime_rl/trainer/models/llama/modeling_llama.py","commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","original_commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Subscripting None labels causes crash in model forward\n\n<!-- **High Severity** -->\n\n<!-- DESCRIPTION START -->\nThe model forward methods attempt to subscript `labels[:, slice_indices]` without checking if `labels` is `None`. When `labels` is `None` (which is the default and used by SFT training at line 243 in `sft/train.py`), this will raise a `TypeError`. The `FusedLmHead` and `WrappedLmHead` classes handle `None` labels correctly, but the crash occurs in the model's forward method before the lm_head is called.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsrc/prime_rl/trainer/models/llama/modeling_llama.py#L294-L295\nsrc/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L310-L311\nsrc/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L411-L412\nLOCATIONS END -->\n<details>\n<summary>Additional Locations (2)</summary>\n\n- [`src/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L310-L311`](https://github.com/PrimeIntellect-ai/prime-rl/blob/7762b5ad39291f0c6c04a52b8a84e7d0fe91b148/src/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L310-L311)\n- [`src/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L411-L412`](https://github.com/PrimeIntellect-ai/prime-rl/blob/7762b5ad39291f0c6c04a52b8a84e7d0fe91b148/src/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L411-L412)\n\n</details>\n\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OmJhMjczMjdjLWNhYzItNGUzMC05ZDA3LWI5MjNhNGRlNzMwZSIsImVuY3J5cHRpb25LZXkiOiI5NEpibGlnZ3QtWUM3b293S1N4ejk3QTRMR1NDTzJ0dmJSTEJGcWlHalI4IiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzI5OTExMiwiZXhwIjoxNzY5ODkxMTEyfQ.P2DnUQbYg3THyv7rLA3Wj4P72urItA00MPKMJ304DG5rOxKxVmwOXfPO55w9m3o1iIfg0MR17Zl-f5IuKXX2yZuLMRiEov3z4P8bW1lBB5uRPA_mzZUYfiLyeNpdTW2S42B7yC-AaiGKO900T2C--nDhtFfJ8mpbBajQo0dUk8W2Op9wJ1PBtOtdYIH7Pfg_OIkaohlzBv7SGR3hzmNtuXkostbYGJhTFCH3mRWS96IURQMHSITwl2L_t7BIblZkp17qn0ryFrhQOrJ3qAwuZzDbbZ8WZkDLBUV6siJKHKDVHfo3iaELq_Dkt61LwefhJYjbiGnKWWkIj1KAafjb2A\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OmJhMjczMjdjLWNhYzItNGUzMC05ZDA3LWI5MjNhNGRlNzMwZSIsImVuY3J5cHRpb25LZXkiOiI5NEpibGlnZ3QtWUM3b293S1N4ejk3QTRMR1NDTzJ0dmJSTEJGcWlHalI4IiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijc3NjJiNWFkMzkyOTFmMGM2YzA0YTUyYjhhODRlN2QwZmU5MWIxNDgiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3NjcyOTkxMTIsImV4cCI6MTc2OTg5MTExMn0.atG3cZ0YQtN6873uZNtm1Qozf3ADR838WIbXxRDp1_zACICMmPzHgO5cclGCRYuafmpa9ixfUGPpgnigYA_bqfMFVqSbkr3DhOeyXFWJ9s6yzDQh-DpxgKN6IMm7Zy4BHumjow36IgugYStbYY17wnzKW9PsZzgvDNCKRyCt3ucrNOmqLb_OGIY3xUm5zrgsW-kP1btbz8wQV1khbjAqTizaSizkhya9mHBGO9s2Gfcrbifc9wz7Pyh2a130D-UPGswC1qVsvW3Arpz69feETz5_yUkU0j_wlWKbuUVJ2ZxH8eoc666bpZd8xH-9pgorukfDxHXkF8RkJbLhFDeVsw\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-01T20:25:12Z","updated_at":"2026-01-01T20:25:12Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591343","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591343"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591343"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591343/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":295,"side":"RIGHT","author_association":"NONE","original_position":51,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591344","pull_request_review_id":3622037691,"id":2656591344,"node_id":"PRRC_kwDON7QmxM6eWF3w","diff_hunk":"@@ -237,6 +237,13 @@ class ModelConfig(BaseConfig):\n         ),\n     ] = DebugModelConfig()\n \n+    fused_lm_head_chunk_size: Annotated[\n+        int | None,\n+        Field(\n+            description=\"The chunk size to use for the model. If None, will not use chunking.\",\n+        ),\n+    ] = None","path":"src/prime_rl/trainer/config.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Config field added without CHANGELOG update (Bugbot Rules)\n\n<!-- **Low Severity** -->\n\n<!-- DESCRIPTION START -->\nThe `fused_lm_head_chunk_size` config field was added to `ModelConfig` in `src/prime_rl/trainer/config.py`, but `CHANGELOG.md` was not updated. This violates the changelog enforcement rule which requires any PR that modifies configuration structures in `src/prime_rl/*/config.py` to update the changelog.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsrc/prime_rl/trainer/config.py#L239-L245\nLOCATIONS END -->\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjZjZTdiMTkwLTMxYTctNDA1NC1iMGYyLWNjNDBlNWU4ZDE0NyIsImVuY3J5cHRpb25LZXkiOiJnaXh0RGdSVERxQnFiaUJ4b2M5UF81bHdFVmh4YW9KRk1oVjV5V3RzcXRBIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzI5OTExMiwiZXhwIjoxNzY5ODkxMTEyfQ.0k_WfGOMJAoUuQSwo8br76IInLhD4T-kKD3LWUcR_urZ6MoPtEjD3FnyI1mybPTfHoj3avWQak5CocnEU5jrDnQ-lwJ5dA4FKX4aoOIRbRE-W6Y71XsCDHskvgATFnH5miH7Nj-bkPMYWJp3we6jQVMYTKWEwOLNqJG08pjdEoYMv0PSBSftQq6I128q5n7I4ZGdGVIYD62jCsZ-dxl8zz50oHjaFFJGr8Kjyl-ZbcP0A5qBnCtMvaTOK6J0zNfISAnWBZgbSAyi9HA8WHz0RH_yigl9ZDrQPT8Jtpz1DdnkU5DcP1k5gnvdMVdvP-SUVFZZxPWukRbBlKaUf-Pgdg\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjZjZTdiMTkwLTMxYTctNDA1NC1iMGYyLWNjNDBlNWU4ZDE0NyIsImVuY3J5cHRpb25LZXkiOiJnaXh0RGdSVERxQnFiaUJ4b2M5UF81bHdFVmh4YW9KRk1oVjV5V3RzcXRBIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijc3NjJiNWFkMzkyOTFmMGM2YzA0YTUyYjhhODRlN2QwZmU5MWIxNDgiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3NjcyOTkxMTIsImV4cCI6MTc2OTg5MTExMn0.WXqr-FNSINs3v-sbL-M5S6YOHWDxUfANWVZ8v83bQCgauZrohWnz0utYk28bt3Oav4ZSeG3KSwX54Y_6EGjc-h5fmGY_wcsnikRq9An8gB6y3pha4QJY8ec78mIqpQT4FCbgTGc6WrJSXCmpYrcU-T8vIdf3js_mW8ZTSEE59zwc_eOYh5lDt1x4TUC1IotnKWx649Nwc33-5wAtglNPslrAOD3-odTp0dDNAt30y1BLM8j6wOFSLnmIwSS1SF745G6isgkKlnb0WW7nPqxomtSiEjksgVp25D3pbP6BWGeipLKqaI2pP9jvQkThsccCuGAc6OenlosBoizKqc1rSw\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-01T20:25:12Z","updated_at":"2026-01-01T20:25:12Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591344","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591344"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591344"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591344/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":245,"original_line":245,"side":"RIGHT","author_association":"NONE","original_position":9,"position":9,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591346","pull_request_review_id":3622037691,"id":2656591346,"node_id":"PRRC_kwDON7QmxM6eWF3y","diff_hunk":"@@ -260,25 +259,35 @@ def train(config: RLTrainerConfig):\n             loss_scale = batch_size\n         loss_scale = max(loss_scale, 1)\n \n-        logger.debug(f\"Starting forward and backward pass ({batch_size=})\")\n+        seq_len = micro_batches[0][\"input_ids\"].shape[1]\n+\n+        logger.debug(f\"Starting forward and backward pass ({batch_size=}, {seq_len=})\")\n         tensors = Tensors()  # Used to accumulate tensor statistics across micro-batches and ranks for logging\n         cp_enabled = parallel_dims.cp_enabled\n         cp_rank = parallel_dims.world_mesh[\"cp\"].get_local_rank() if cp_enabled else 0\n         cp_group = parallel_dims.world_mesh[\"cp\"].get_group() if cp_enabled else None\n         cp_size = parallel_dims.cp\n \n         for micro_step, micro_batch in enumerate(micro_batches):\n-            input_ids = micro_batch[\"input_ids\"].to(\"cuda\")\n+            labels = micro_batch[\"input_ids\"].to(\"cuda\")\n             position_ids = micro_batch[\"position_ids\"].to(\"cuda\")\n             advantages = micro_batch[\"advantages\"].to(\"cuda\")\n             loss_mask = micro_batch[\"loss_mask\"].to(\"cuda\")\n             inference_logprobs = micro_batch[\"inference_logprobs\"].to(\"cuda\")\n-            teacher_logprobs = micro_batch[\"teacher_logprobs\"].to(\"cuda\") if micro_batch[\"teacher_logprobs\"] is not None else None\n+            teacher_logprobs = (\n+                micro_batch[\"teacher_logprobs\"].to(\"cuda\") if micro_batch[\"teacher_logprobs\"] is not None else None\n+            )\n+\n+            input_ids = shift_tensor_right(labels)\n+            position_ids = shift_tensor_right(position_ids)","path":"src/prime_rl/trainer/rl/train.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Position IDs incorrectly shifted corrupts positional encoding\n\n<!-- **High Severity** -->\n\n<!-- DESCRIPTION START -->\nThe `position_ids` tensor is shifted right using `shift_tensor_right(position_ids)`, transforming `[0, 1, 2, 3, ...]` into `[0, 0, 1, 2, ...]`. This creates duplicate position 0 values and incorrect positional encoding. The shifted position_ids are passed to the model via `forward_position_ids`, causing incorrect attention behavior, and also to `get_response_lengths` which expects positions to increment from 0. Only `input_ids` should be shifted to align inputs with labels; `position_ids` should remain sequential.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsrc/prime_rl/trainer/rl/train.py#L281-L282\nLOCATIONS END -->\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjQ0MWRlMGM3LTI3YjQtNDg3YS05N2I2LWRiOTRlZGZiYTYzNSIsImVuY3J5cHRpb25LZXkiOiJMcHRPaXBZWXZGMkVYNTNlRXNEaE56Ujc0QmhlSDFtUUk1Q0dRaDF2Ymo0IiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzI5OTExMiwiZXhwIjoxNzY5ODkxMTEyfQ.Hnvt0_nngnmgsOPXkvvMuWej95kT9LMaIoYRxXaqKVc7WfNZNcDvR4hgWzKcs6mGinaezIbPPnrtSCyJZOjHUr2CmryRKVtB0q5QMcf-xW_1Twh66WL-cLds_c9FiIFyQY20RnDJ2vwtjMpWTlBabEtO80R4KAmOY0enBC4ORev-sAHVKbNKQopb7IY-_jWPV0NAkM16280YJS3G2uz2WMemAQCtWbgnvyss8ojx2vN9IuYqt5bjFWj6BrmUci9Sa4Do3yjbmg68WqJtMi52vzHgxb0VNRT6vwr_vljIKczOSE9YFm98L-r6eB1XqRo6Z9t2Lr5O_2stG78MWzXSOw\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjQ0MWRlMGM3LTI3YjQtNDg3YS05N2I2LWRiOTRlZGZiYTYzNSIsImVuY3J5cHRpb25LZXkiOiJMcHRPaXBZWXZGMkVYNTNlRXNEaE56Ujc0QmhlSDFtUUk1Q0dRaDF2Ymo0IiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijc3NjJiNWFkMzkyOTFmMGM2YzA0YTUyYjhhODRlN2QwZmU5MWIxNDgiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3NjcyOTkxMTIsImV4cCI6MTc2OTg5MTExMn0.jTjSkLza0nRzMcYUdW8USTgv4YFz4SCWRA6j6hoo3c-ooVPzJyoc9mYy48T4-W_FQs73ApaxLv65EuPrGPAwLLr6c0aPeIL2D5kxAPM25WkoAfP8DauSlu9NF7aK9u-WD4bFoiaKj_vSpBr1eEDGAkWC_O5eOjzMqDgPazLZP_wdbq3EFHUS1UBqIbZQw4J1KnFBgqT_Vga2Dp477sz5xXU6Eq9rLNuDtynyh5mnTHXrdz59SQYISfJMbMrH23DZg5md3iFYarghP7PwJZO01-y0-efXHhZvZTuvqb3Ty54yA8etdZG68yj_kAaI1htP0hjH5oOdjfhIOKpHNkPiEA\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-01T20:25:12Z","updated_at":"2026-01-01T20:25:12Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591346","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591346"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591346"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591346/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":281,"original_line":282,"side":"RIGHT","author_association":"NONE","original_position":45,"position":33,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591347","pull_request_review_id":3622037691,"id":2656591347,"node_id":"PRRC_kwDON7QmxM6eWF3z","diff_hunk":"@@ -0,0 +1,43 @@\n+set -e\n+\n+export BS=${BS:-8}\n+export SEQ=${SEQ:-8192}\n+export WORLD_SIZE=${WORLD_SIZE:-8}\n+export RUN_NAME=${RUN_NAME:-debug-sft}\n+export WANDB_RUN_NAME=${WANDB_RUN_NAME:-${RUN_NAME}}\n+\n+OUTPUT_DIR=\"/data/prime-rl/outputs/${RUN_NAME}\"\n+export OUTPUT_DIR\n+\n+mkdir -p $OUTPUT_DIR/logs\n+\n+ROOT_DIR=$(pwd)\n+\n+echo \"ROOT_DIR: $ROOT_DIR\"\n+\n+bash -c '\n+    cd \"$ROOT_DIR\"\n+    source /home/ubuntu/workspace/prime-rl/.env","path":"sft.sh","commit_id":"815cc08e3fa44d75a65d77fe7a8d5e403cd53cc4","original_commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Hardcoded user-specific path in shell script\n\n<!-- **Low Severity** -->\n\n<!-- DESCRIPTION START -->\nThe script sources a hardcoded user-specific path `/home/ubuntu/workspace/prime-rl/.env` which will fail on any other machine. This appears to be development-specific code that was accidentally committed.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsft.sh#L19-L20\nLOCATIONS END -->\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjhlNThjNWYxLTE2OGItNDk1ZS1iMzExLTUyOThmZjE3N2YyNiIsImVuY3J5cHRpb25LZXkiOiJkY2VuSE1SYS1XODFKRnl4endIeTAwY1lkLU1Ea3E2SmwyUmtYeEZjZnBVIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzI5OTExMiwiZXhwIjoxNzY5ODkxMTEyfQ.PiTwTRwkIjuEPTIo5XFq3THtHK7CHCicAi6GmMntrHlEP4Y46X0GbiwN7NXR8xRAF9qaSmLNI-mgl7yUD6KGn9WhZGCvYJCG_a961EgR_aAc5jpOPo6qQQpB4O_IK5QpV8cpvQOR51KXKleqcf7AvpxOGA0Oe3c7iOORO80b7n1036Iwlzjzv09VOUl3Fmirgter8AoLRGgya-yvpTcgTMQ80gndWx-C1lUz7-a__YdGJBoI0O_E7bvvWJtGlOwYxicoLkQu7qtA8okVotnHnIZtad-TRy1GYUj_cW7BaMSRc-BnCtxwmG3chXacb1lKfpnxP5mY12l6hYgR20MC1A\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjhlNThjNWYxLTE2OGItNDk1ZS1iMzExLTUyOThmZjE3N2YyNiIsImVuY3J5cHRpb25LZXkiOiJkY2VuSE1SYS1XODFKRnl4endIeTAwY1lkLU1Ea3E2SmwyUmtYeEZjZnBVIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijc3NjJiNWFkMzkyOTFmMGM2YzA0YTUyYjhhODRlN2QwZmU5MWIxNDgiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3NjcyOTkxMTIsImV4cCI6MTc2OTg5MTExMn0.nNY6Lir6rHjXSbZNmCQdvbz_0TKogSczYGHfk-1uf_-vO00pA7_rUYCWQueDRE86vaqJAeQR5zuFWhaGRAXaMp7c6yuBhMCBi6e-QikYVgjjt55SpFrw5kOHOxxuoF1SmqoNhtKxwVOlle0dWbskmLsQrYbRZK9Wk07GmtbvbGi8v5bTHasGpFUmWOtB97Z2XYtbzNWLLCJspebjBEXh9BPZtK0_fQv2J39T5GtuSKjuCqO6kV8IMP2lVF6rsxIHW2wnsgWPV1x0ePQ8zbEhhIpPRM3KsSY30cyuPy4uQ_Nt7ixWYnuTEglgi7j1PwvjyxPJxyZ8f9maB09hP4R2Hg\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-01T20:25:12Z","updated_at":"2026-01-01T20:25:12Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591347","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591347"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591347"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591347/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":20,"side":"RIGHT","author_association":"NONE","original_position":20,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591348","pull_request_review_id":3622037691,"id":2656591348,"node_id":"PRRC_kwDON7QmxM6eWF30","diff_hunk":"@@ -65,6 +65,7 @@ def _get_cu_seqlens_for_cp(position_ids: torch.Tensor) -> torch.Tensor:\n def setup_cp_params(\n     input_ids: torch.Tensor,\n     position_ids: torch.Tensor,\n+    labels: torch.Tensor,","path":"src/prime_rl/utils/cp.py","commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","original_commit_id":"7762b5ad39291f0c6c04a52b8a84e7d0fe91b148","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Return type annotation mismatches actual return value\n\n<!-- **Medium Severity** -->\n\n<!-- DESCRIPTION START -->\nThe `setup_cp_params` function's return type annotation declares `tuple[torch.Tensor, torch.Tensor]` (2 tensors), but the function actually returns 3 tensors: `(input_ids, position_ids, labels)`. This mismatch could cause unpacking errors or confusion for callers expecting only 2 return values.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsrc/prime_rl/utils/cp.py#L71-L72\nLOCATIONS END -->\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OmI1ZmY4MjM5LWM4YjAtNDljYy05ZjkzLTBlZmNkZjgxMGZhYiIsImVuY3J5cHRpb25LZXkiOiIwckVwT1pTZUhLZUNaSklxR1d1OGdsRkM4UTQtNDZVejd0U052djRGSjRFIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzI5OTExMiwiZXhwIjoxNzY5ODkxMTEyfQ.HEqB27q22OuZ5qmfnjJNsMmZomTVReNp1tgqA6QHHKhstu2cbLv96v19ioEBz0cFKLYb5RGLrH8QNmSBvqzOMqM3n0DdVHMpLa6YMI3tW7ffXj3fs7Out9_EmXEhjqx5S3TAGBNbzXZlQfnavyRxJE23sH9ZhFLhHi5gor0NV7AREtFnpDlLby8m4UOfHERXD0tQrdDpe0wndRaTGtI14ZEJ9AeNHNaU7hfYADK31hK6mTCw_MUjd-_MSX6e3pytDxzl12sUhg_FjDYxUuVJmMXleIAORPVy40nX4I_SHKlDboDCILbTWHk189p8bzuoDfYBORsdgdOe6BaSt-kgkA\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OmI1ZmY4MjM5LWM4YjAtNDljYy05ZjkzLTBlZmNkZjgxMGZhYiIsImVuY3J5cHRpb25LZXkiOiIwckVwT1pTZUhLZUNaSklxR1d1OGdsRkM4UTQtNDZVejd0U052djRGSjRFIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijc3NjJiNWFkMzkyOTFmMGM2YzA0YTUyYjhhODRlN2QwZmU5MWIxNDgiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3NjcyOTkxMTIsImV4cCI6MTc2OTg5MTExMn0.LdnksB2gZ7Xc-K5Ztjx-vu__ILX3O8lJetwxFO2RHzGI9pwENpdTh1MJ2SewXGa2YlnzZKknaJo7b7iZIa0FPhZAE5QBKJLQ9Ak-eoDDR7thSTeoChfwOMb-MOFFY1OfIjv1PURCZEHL4oEyYaWNtjWhgEmhEF1hLHJ5ggKAKAWCnJs6lX4p4wACGcaEqBLNkHRgmv03IpLmA1WEG-O_8Qha9cDY6XMfS_4pDPw3RD5e3IoQv1QSxJwMCzUNtyF6tUISocmX5k5p-O8rc1C2Xqt2c6wWDry7SmFlM2_oQs7ULo5STuKlsle6ujV_4JysXO2GLGnAYjawxhzyxZ5qdQ\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-01T20:25:12Z","updated_at":"2026-01-01T20:25:12Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591348","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591348"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2656591348"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2656591348/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":null,"original_line":68,"side":"RIGHT","author_association":"NONE","original_position":4,"position":1,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658691851","pull_request_review_id":3624177731,"id":2658691851,"node_id":"PRRC_kwDON7QmxM6eeGsL","diff_hunk":"@@ -285,18 +292,10 @@ def forward(\n         hidden_states = outputs.last_hidden_state\n         # Only compute necessary logits, and do not upcast them to float if we are not computing the loss\n         slice_indices = slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep\n-        logits = self.lm_head(hidden_states[:, slice_indices, :])\n-\n-        loss = None\n-        if labels is not None:\n-            loss = self.loss_function(logits=logits, labels=labels, vocab_size=self.config.vocab_size, **kwargs)\n-\n-        return CausalLMOutputWithPast(\n-            loss=loss,\n-            logits=logits,\n-            past_key_values=outputs.past_key_values,\n-            hidden_states=outputs.hidden_states,\n-            attentions=outputs.attentions,\n+        return self.lm_head(\n+            hidden_states[:, slice_indices, :],\n+            labels[:, slice_indices] if labels is not None else None,\n+            temperature=temperature,","path":"src/prime_rl/trainer/models/llama/modeling_llama.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"cursor[bot]","id":206951365,"node_id":"BOT_kgDODFXTxQ","avatar_url":"https://avatars.githubusercontent.com/in/1210556?v=4","gravatar_id":"","url":"https://api.github.com/users/cursor%5Bbot%5D","html_url":"https://github.com/apps/cursor","followers_url":"https://api.github.com/users/cursor%5Bbot%5D/followers","following_url":"https://api.github.com/users/cursor%5Bbot%5D/following{/other_user}","gists_url":"https://api.github.com/users/cursor%5Bbot%5D/gists{/gist_id}","starred_url":"https://api.github.com/users/cursor%5Bbot%5D/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cursor%5Bbot%5D/subscriptions","organizations_url":"https://api.github.com/users/cursor%5Bbot%5D/orgs","repos_url":"https://api.github.com/users/cursor%5Bbot%5D/repos","events_url":"https://api.github.com/users/cursor%5Bbot%5D/events{/privacy}","received_events_url":"https://api.github.com/users/cursor%5Bbot%5D/received_events","type":"Bot","user_view_type":"public","site_admin":false},"body":"### Temperature None passed to FusedOutputLinear causes TypeError\n\n<!-- **Medium Severity** -->\n\n<!-- DESCRIPTION START -->\nWhen the model's forward method is called without an explicit `temperature` argument (or with `temperature=None`), the `None` value is passed directly to the lm_head as `temperature=temperature`. In `FusedOutputLinear.forward`, while the signature has `temperature: float = 1.0`, explicitly passing `None` overrides this default. This causes `1.0 / float(None)` on line 41 of `lm_head.py` to raise a `TypeError`. The model docstrings claim temperature \"defaults to 1.0\" but the implementation doesn't handle `None` correctly when `FusedOutputLinear` is used.\n<!-- DESCRIPTION END -->\n\n<!-- LOCATIONS START\nsrc/prime_rl/trainer/models/llama/modeling_llama.py#L297-L298\nsrc/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L313-L314\nsrc/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L414-L415\nLOCATIONS END -->\n<details>\n<summary>Additional Locations (2)</summary>\n\n- [`src/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L313-L314`](https://github.com/PrimeIntellect-ai/prime-rl/blob/94a70931cd74a7f105d1c12f179733cc8fc62110/src/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py#L313-L314)\n- [`src/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L414-L415`](https://github.com/PrimeIntellect-ai/prime-rl/blob/94a70931cd74a7f105d1c12f179733cc8fc62110/src/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py#L414-L415)\n\n</details>\n\n<a href=\"https://cursor.com/open?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9DVVJTT1IiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjUyOGRiYTY1LTcxY2UtNDg2ZC1iN2U3LTk4YjhlZjZkOTdmNyIsImVuY3J5cHRpb25LZXkiOiItUUlqeUctdGlBOVVZNWg3S21ZbHlwZkJYOGhVSFlRT0RrMVd4YzJFSlVBIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIn0sImlhdCI6MTc2NzQxMjE5NCwiZXhwIjoxNzcwMDA0MTk0fQ.veTd47fHY71ZWf4ie7u3G65wZCCqTIteDWCUdGtR0ZD9sx834DSo07zAKD0VSEl1_YAjRnOqJXuGHRVBoSzfoRuzY-ugjS6dVqhcoNkfBaU5TLA0WDeF-UNm-01AdvXJUl2_dFpThNoT-juPHpqYNsUwwQ04pUH0rFt_cFuTbr-d9cfmTvX2MOtxyfCi1JF5uK9TEQhaDoekE0xLIjCTlO2a_mANHHxw09KFmZjaiAfMMl5FhIV5E8ZXG8V3a4QX4Y0bM-kgkdPU6QFJfygDzMBGJekKDM0Fbh7NVtRv8Zd_vHDuIO8TFWnvqupSdEPBtsHP6f5S_RONnZ4mF_kSTw\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-cursor-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-cursor-light.svg\"><img alt=\"Fix in Cursor\" src=\"https://cursor.com/fix-in-cursor.svg\"></picture></a>&nbsp;<a href=\"https://cursor.com/agents?data=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImJ1Z2JvdC12MiJ9.eyJ2ZXJzaW9uIjoxLCJ0eXBlIjoiQlVHQk9UX0ZJWF9JTl9XRUIiLCJkYXRhIjp7InJlZGlzS2V5IjoiYnVnYm90OjUyOGRiYTY1LTcxY2UtNDg2ZC1iN2U3LTk4YjhlZjZkOTdmNyIsImVuY3J5cHRpb25LZXkiOiItUUlqeUctdGlBOVVZNWg3S21ZbHlwZkJYOGhVSFlRT0RrMVd4YzJFSlVBIiwiYnJhbmNoIjoiY2h1bmtlZC1sb3NzIiwicmVwb093bmVyIjoiUHJpbWVJbnRlbGxlY3QtYWkiLCJyZXBvTmFtZSI6InByaW1lLXJsIiwicHJOdW1iZXIiOjE1MjUsImNvbW1pdFNoYSI6Ijk0YTcwOTMxY2Q3NGE3ZjEwNWQxYzEyZjE3OTczM2NjOGZjNjIxMTAiLCJwcm92aWRlciI6ImdpdGh1YiJ9LCJpYXQiOjE3Njc0MTIxOTQsImV4cCI6MTc3MDAwNDE5NH0.RUh57YIicDvOD9orOnDI0ifcVFtiTA0uWJlZ48FUIrVfI9-XXwX2i-5nkh-fjR9KBOEaLtZHLM_NYA6_xJ69H-qlTd_7_UeuwzNWEoPVYBJpB2m-3QhK_JOXv0KP7DAepkTJyrZ6TmvCImvkN7UpDTE3rr0qmpUAy3g3LKxJs408JY2_Q5YoVzytdRsQhps2r-l3wr8z2hkaCEnTzxU-1Ldf_ZNNei0nHLZMn7iDH3pdksvWwoLB8o6AYvU4MURDbq9ZiaCpgS0fk8tqHC1eQSbmaLLsbSaLF4QwvBY-PYwxY6mkbx0pr4R2yCiJ5oTwbDPeKpQeVQQEU50f18AG5Q\" target=\"_blank\" rel=\"noopener noreferrer\"><picture><source media=\"(prefers-color-scheme: dark)\" srcset=\"https://cursor.com/fix-in-web-dark.svg\"><source media=\"(prefers-color-scheme: light)\" srcset=\"https://cursor.com/fix-in-web-light.svg\"><img alt=\"Fix in Web\" src=\"https://cursor.com/fix-in-web.svg\"></picture></a>\n\n","created_at":"2026-01-03T03:49:54Z","updated_at":"2026-01-03T03:49:54Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658691851","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658691851"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658691851"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658691851/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":298,"original_line":298,"side":"RIGHT","author_association":"NONE","original_position":53,"position":53,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698103","pull_request_review_id":3624181642,"id":2658698103,"node_id":"PRRC_kwDON7QmxM6eeIN3","diff_hunk":"@@ -285,18 +292,10 @@ def forward(\n         hidden_states = outputs.last_hidden_state\n         # Only compute necessary logits, and do not upcast them to float if we are not computing the loss\n         slice_indices = slice(-logits_to_keep, None) if isinstance(logits_to_keep, int) else logits_to_keep\n-        logits = self.lm_head(hidden_states[:, slice_indices, :])\n-\n-        loss = None\n-        if labels is not None:\n-            loss = self.loss_function(logits=logits, labels=labels, vocab_size=self.config.vocab_size, **kwargs)\n-\n-        return CausalLMOutputWithPast(\n-            loss=loss,\n-            logits=logits,\n-            past_key_values=outputs.past_key_values,\n-            hidden_states=outputs.hidden_states,\n-            attentions=outputs.attentions,\n+        return self.lm_head(\n+            hidden_states[:, slice_indices, :],\n+            labels[:, slice_indices] if labels is not None else None,\n+            temperature=temperature,","path":"src/prime_rl/trainer/models/llama/modeling_llama.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"i guess making the default 1.0 for the forward func method resolve this","created_at":"2026-01-03T04:07:41Z","updated_at":"2026-01-03T04:07:48Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698103","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698103"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698103"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698103/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":298,"original_line":298,"side":"RIGHT","in_reply_to_id":2658691851,"author_association":"MEMBER","original_position":53,"position":53,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698512","pull_request_review_id":3624181923,"id":2658698512,"node_id":"PRRC_kwDON7QmxM6eeIUQ","diff_hunk":"@@ -263,9 +264,16 @@ def forward(\n         use_cache: Optional[bool] = None,\n         cache_position: Optional[torch.LongTensor] = None,\n         logits_to_keep: Union[int, torch.Tensor] = 0,\n+        temperature: Optional[float] = None,","path":"src/prime_rl/trainer/models/glm4_moe/modeling_glm4_moe.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"change default to 1.0 here too","created_at":"2026-01-03T04:08:59Z","updated_at":"2026-01-03T04:08:59Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698512","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698512"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698512"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698512/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":267,"original_line":267,"side":"RIGHT","author_association":"MEMBER","original_position":21,"position":21,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698615","pull_request_review_id":3624181997,"id":2658698615,"node_id":"PRRC_kwDON7QmxM6eeIV3","diff_hunk":"@@ -359,13 +360,16 @@ def forward(\n         output_router_logits: Optional[bool] = None,\n         cache_position: Optional[torch.LongTensor] = None,\n         logits_to_keep: Union[int, torch.Tensor] = 0,\n+        temperature: Optional[float] = None,","path":"src/prime_rl/trainer/models/qwen3_moe/modeling_qwen3_moe.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"and ere","created_at":"2026-01-03T04:09:20Z","updated_at":"2026-01-03T04:09:20Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698615","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698615"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658698615"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658698615/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":363,"original_line":363,"side":"RIGHT","author_association":"MEMBER","original_position":19,"position":19,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658702195","pull_request_review_id":3624184814,"id":2658702195,"node_id":"PRRC_kwDON7QmxM6eeJNz","diff_hunk":"@@ -277,10 +277,15 @@ def train(config: RLTrainerConfig):\n                 micro_batch[\"teacher_logprobs\"].to(\"cuda\") if micro_batch[\"teacher_logprobs\"] is not None else None\n             )\n \n+            input_ids = shift_tensor_right(labels)\n+            position_ids = shift_tensor_right(position_ids)\n+","path":"src/prime_rl/trainer/rl/train.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"will this make there be a padding token at the beginning of the sequence which makes the calc wrong?","created_at":"2026-01-03T04:13:50Z","updated_at":"2026-01-03T04:13:50Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658702195","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658702195"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658702195"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658702195/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":280,"original_start_line":280,"start_side":"RIGHT","line":282,"original_line":282,"side":"RIGHT","author_association":"MEMBER","original_position":34,"position":34,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658707237","pull_request_review_id":3624188910,"id":2658707237,"node_id":"PRRC_kwDON7QmxM6eeKcl","diff_hunk":"@@ -0,0 +1,184 @@\n+from __future__ import annotations\n+\n+from dataclasses import dataclass\n+\n+import torch\n+from torch import Tensor\n+\n+\n+@dataclass\n+class PrimeLmOutput:\n+    logits: Tensor | None = None\n+    logprobs: Tensor | None = None\n+    entropy: Tensor | None = None\n+\n+    def postprocess(self) -> PrimeLmOutput:\n+        \"\"\"Postprocess the output with tensors converted to float and made contiguous.\"\"\"\n+\n+        def _process_output_tensor(tensor: Tensor | None) -> Tensor | None:\n+            return tensor.float().contiguous() if tensor is not None else None\n+\n+        return PrimeLmOutput(\n+            logits=_process_output_tensor(self.logits),\n+            logprobs=_process_output_tensor(self.logprobs),\n+            entropy=_process_output_tensor(self.entropy),\n+        )","path":"src/prime_rl/trainer/models/layers/lm_head.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"hrmm i feel like it might be better to have the float().contiguous be inline rather than hidden in a function here. its quite short and its probably easier to read directly in the line itself","created_at":"2026-01-03T04:24:04Z","updated_at":"2026-01-03T04:24:04Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658707237","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658707237"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658707237"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658707237/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":15,"original_start_line":15,"start_side":"RIGHT","line":25,"original_line":25,"side":"RIGHT","author_association":"MEMBER","original_position":25,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710101","pull_request_review_id":3624190701,"id":2658710101,"node_id":"PRRC_kwDON7QmxM6eeLJV","diff_hunk":"@@ -0,0 +1,184 @@\n+from __future__ import annotations\n+\n+from dataclasses import dataclass\n+\n+import torch\n+from torch import Tensor\n+\n+\n+@dataclass\n+class PrimeLmOutput:\n+    logits: Tensor | None = None\n+    logprobs: Tensor | None = None\n+    entropy: Tensor | None = None\n+\n+    def postprocess(self) -> PrimeLmOutput:\n+        \"\"\"Postprocess the output with tensors converted to float and made contiguous.\"\"\"\n+\n+        def _process_output_tensor(tensor: Tensor | None) -> Tensor | None:\n+            return tensor.float().contiguous() if tensor is not None else None\n+\n+        return PrimeLmOutput(\n+            logits=_process_output_tensor(self.logits),\n+            logprobs=_process_output_tensor(self.logprobs),\n+            entropy=_process_output_tensor(self.entropy),\n+        )","path":"src/prime_rl/trainer/models/layers/lm_head.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"or maybe just call it cast_float_and_contiguous","created_at":"2026-01-03T04:32:15Z","updated_at":"2026-01-03T04:32:15Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658710101","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710101"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658710101"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710101/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":15,"original_start_line":15,"start_side":"RIGHT","line":25,"original_line":25,"side":"RIGHT","in_reply_to_id":2658707237,"author_association":"MEMBER","original_position":25,"position":25,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710541","pull_request_review_id":3624190986,"id":2658710541,"node_id":"PRRC_kwDON7QmxM6eeLQN","diff_hunk":"@@ -388,6 +397,15 @@ def setup_model(\n \n @jaxtyped(typechecker=typechecker)\n def forward(\n-    model: nn.Module, input_ids: Int[Tensor, \"batch seq\"], position_ids: Int[Tensor, \"batch seq\"]\n-) -> Float[Tensor, \"batch seq vocab\"]:\n-    return model(input_ids=input_ids, position_ids=position_ids).logits\n+    model: nn.Module,\n+    input_ids: Int[Tensor, \"batch seq\"],\n+    position_ids: Int[Tensor, \"batch seq\"],\n+    labels: Int[Tensor, \"batch seq\"] | None = None,\n+    temperature: float | None = None,\n+) -> PrimeLmOutput:\n+    out = model(input_ids=input_ids, position_ids=position_ids, labels=labels, temperature=temperature)\n+\n+    if isinstance(out, PrimeLmOutput):\n+        return out\n+\n+    return PrimeLmOutput(logits=out.logits)","path":"src/prime_rl/trainer/model.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"maybe call postprocess / cast_float_and_contiguous here instead?","created_at":"2026-01-03T04:33:40Z","updated_at":"2026-01-03T04:40:39Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658710541","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710541"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658710541"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658710541/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":null,"original_start_line":null,"start_side":null,"line":411,"original_line":411,"side":"RIGHT","author_association":"MEMBER","original_position":52,"position":52,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711204","pull_request_review_id":3624191366,"id":2658711204,"node_id":"PRRC_kwDON7QmxM6eeLak","diff_hunk":"@@ -388,6 +397,15 @@ def setup_model(\n \n @jaxtyped(typechecker=typechecker)\n def forward(\n-    model: nn.Module, input_ids: Int[Tensor, \"batch seq\"], position_ids: Int[Tensor, \"batch seq\"]\n-) -> Float[Tensor, \"batch seq vocab\"]:\n-    return model(input_ids=input_ids, position_ids=position_ids).logits\n+    model: nn.Module,\n+    input_ids: Int[Tensor, \"batch seq\"],\n+    position_ids: Int[Tensor, \"batch seq\"],\n+    labels: Int[Tensor, \"batch seq\"] | None = None,\n+    temperature: float | None = None,\n+) -> PrimeLmOutput:\n+    out = model(input_ids=input_ids, position_ids=position_ids, labels=labels, temperature=temperature)\n+\n+    if isinstance(out, PrimeLmOutput):\n+        return out\n+\n+    return PrimeLmOutput(logits=out.logits)","path":"src/prime_rl/trainer/model.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"I think it would be better to move the `if out.logprobs is None` case into here. its to cover the case where we dont have custom model right?","created_at":"2026-01-03T04:35:37Z","updated_at":"2026-01-03T04:35:37Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658711204","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711204"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658711204"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711204/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":408,"original_start_line":408,"start_side":"RIGHT","line":411,"original_line":411,"side":"RIGHT","author_association":"MEMBER","original_position":52,"position":52,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711866","pull_request_review_id":3624191792,"id":2658711866,"node_id":"PRRC_kwDON7QmxM6eeLk6","diff_hunk":"@@ -388,6 +397,15 @@ def setup_model(\n \n @jaxtyped(typechecker=typechecker)\n def forward(\n-    model: nn.Module, input_ids: Int[Tensor, \"batch seq\"], position_ids: Int[Tensor, \"batch seq\"]\n-) -> Float[Tensor, \"batch seq vocab\"]:\n-    return model(input_ids=input_ids, position_ids=position_ids).logits\n+    model: nn.Module,\n+    input_ids: Int[Tensor, \"batch seq\"],\n+    position_ids: Int[Tensor, \"batch seq\"],\n+    labels: Int[Tensor, \"batch seq\"] | None = None,\n+    temperature: float | None = None,\n+) -> PrimeLmOutput:\n+    out = model(input_ids=input_ids, position_ids=position_ids, labels=labels, temperature=temperature)\n+\n+    if isinstance(out, PrimeLmOutput):\n+        return out\n+\n+    return PrimeLmOutput(logits=out.logits)","path":"src/prime_rl/trainer/model.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"so the forward always returns fully populated `PrimeLmOutput` and the train.py just deals with stuff assuming it already has the logprobs and entropy which is cleaner","created_at":"2026-01-03T04:37:15Z","updated_at":"2026-01-03T04:41:06Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658711866","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711866"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658711866"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658711866/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":408,"original_start_line":408,"start_side":"RIGHT","line":411,"original_line":411,"side":"RIGHT","in_reply_to_id":2658711204,"author_association":"MEMBER","original_position":52,"position":52,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658712336","pull_request_review_id":3624192109,"id":2658712336,"node_id":"PRRC_kwDON7QmxM6eeLsQ","diff_hunk":"@@ -33,6 +33,8 @@ def get_model_pairs():\n         prime_state_keys = prime_model.state_dict().keys()\n         prime_model.convert_to_prime(state_dict)\n         prime_model.load_state_dict(state_dict)\n+    # Training code wraps the LM head; tests should mirror that (so forward can accept labels/temperature).\n+    prime_model.wrap_lm_head(chunk_size=None)","path":"tests/unit/train/models/test_llama.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"we arent passing labels and temperature in this test right?","created_at":"2026-01-03T04:38:31Z","updated_at":"2026-01-03T04:38:32Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658712336","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658712336"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658712336"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658712336/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":36,"original_start_line":36,"start_side":"RIGHT","line":37,"original_line":37,"side":"RIGHT","author_association":"MEMBER","original_position":5,"position":5,"subject_type":"line"},{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658714787","pull_request_review_id":3624193681,"id":2658714787,"node_id":"PRRC_kwDON7QmxM6eeMSj","diff_hunk":"@@ -388,6 +397,15 @@ def setup_model(\n \n @jaxtyped(typechecker=typechecker)\n def forward(\n-    model: nn.Module, input_ids: Int[Tensor, \"batch seq\"], position_ids: Int[Tensor, \"batch seq\"]\n-) -> Float[Tensor, \"batch seq vocab\"]:\n-    return model(input_ids=input_ids, position_ids=position_ids).logits\n+    model: nn.Module,\n+    input_ids: Int[Tensor, \"batch seq\"],\n+    position_ids: Int[Tensor, \"batch seq\"],\n+    labels: Int[Tensor, \"batch seq\"] | None = None,\n+    temperature: float | None = None,\n+) -> PrimeLmOutput:\n+    out = model(input_ids=input_ids, position_ids=position_ids, labels=labels, temperature=temperature)\n+\n+    if isinstance(out, PrimeLmOutput):\n+        return out\n+\n+    return PrimeLmOutput(logits=out.logits)","path":"src/prime_rl/trainer/model.py","commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","original_commit_id":"94a70931cd74a7f105d1c12f179733cc8fc62110","user":{"login":"Jackmin801","id":56836461,"node_id":"MDQ6VXNlcjU2ODM2NDYx","avatar_url":"https://avatars.githubusercontent.com/u/56836461?v=4","gravatar_id":"","url":"https://api.github.com/users/Jackmin801","html_url":"https://github.com/Jackmin801","followers_url":"https://api.github.com/users/Jackmin801/followers","following_url":"https://api.github.com/users/Jackmin801/following{/other_user}","gists_url":"https://api.github.com/users/Jackmin801/gists{/gist_id}","starred_url":"https://api.github.com/users/Jackmin801/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Jackmin801/subscriptions","organizations_url":"https://api.github.com/users/Jackmin801/orgs","repos_url":"https://api.github.com/users/Jackmin801/repos","events_url":"https://api.github.com/users/Jackmin801/events{/privacy}","received_events_url":"https://api.github.com/users/Jackmin801/received_events","type":"User","user_view_type":"public","site_admin":false},"body":"im also wondering if we can get the non PrimeRL models to support the chunking too by splitting their forward into model.model then chunked_lm_head with temperature and labels and we can have that logic here. also fine with this being in another PR and we just dont support chunking for non PrimeRL models for now","created_at":"2026-01-03T04:45:42Z","updated_at":"2026-01-03T04:45:42Z","html_url":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658714787","pull_request_url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525","_links":{"self":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658714787"},"html":{"href":"https://github.com/PrimeIntellect-ai/prime-rl/pull/1525#discussion_r2658714787"},"pull_request":{"href":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/1525"}},"reactions":{"url":"https://api.github.com/repos/PrimeIntellect-ai/prime-rl/pulls/comments/2658714787/reactions","total_count":0,"+1":0,"-1":0,"laugh":0,"hooray":0,"confused":0,"heart":0,"rocket":0,"eyes":0},"start_line":408,"original_start_line":408,"start_side":"RIGHT","line":411,"original_line":411,"side":"RIGHT","in_reply_to_id":2658711204,"author_association":"MEMBER","original_position":52,"position":52,"subject_type":"line"}]